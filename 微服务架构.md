

# ä¸€ã€å¾®æœåŠ¡æ¶æ„

## 1.æ¶æ„ä»‹ç»

1. ç³»ç»Ÿæ¶æ„æ¼”å˜

   1.1 å¾®æœåŠ¡æ¶æ„ä»‹ç»

   Spring Cloud æ˜¯åˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œå®ƒæä¾›äº†ä¸€å¥—ç®€å•æ˜“ç”¨çš„ç¼–ç¨‹æ¨¡å‹ï¼Œä½¿æˆ‘ä»¬èƒ½åœ¨ Spring Boot çš„åŸºç¡€ä¸Šè½»æ¾åœ°å®ç°å¾®æœåŠ¡ç³»ç»Ÿçš„æ„å»ºã€‚ **Spring Cloud æä¾›ä»¥å¾®æœåŠ¡ä¸ºæ ¸å¿ƒçš„åˆ†å¸ƒå¼ç³»ç»Ÿæ„å»ºæ ‡å‡†ã€‚**

   ![spring-cloud](https://sca.aliyun.com/img/overview-doc-img/spring-cloud-img.png)
   
   Spring Cloud æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ªå¼€ç®±å³ç”¨çš„æ¡†æ¶ï¼Œå®ƒæ˜¯ä¸€å¥—å¾®æœåŠ¡è§„èŒƒï¼Œå…±æœ‰ä¸¤ä»£å®ç°ã€‚
   
   - Spring Cloud Netflix æ˜¯ Spring Cloud çš„ç¬¬ä¸€ä»£å®ç°ï¼Œä¸»è¦ç”± Eurekaã€Ribbonã€Feignã€Hystrix ç­‰ç»„ä»¶ç»„æˆã€‚
   
   - Spring Cloud Alibaba æ˜¯ Spring Cloud çš„ç¬¬äºŒä»£å®ç°ï¼Œä¸»è¦ç”± Nacosã€Sentinelã€Seata ç­‰ç»„ä»¶ç»„æˆã€‚
   
     
   
   ä¸€æ—¦é‡‡ç”¨å¾®æœåŠ¡ç³»ç»Ÿæ¶æ„ï¼Œå°±åŠ¿å¿…é‡åˆ°è¿™æ ·å‡ ä¸ªé—®é¢˜ï¼š
   
   - è¿™ä¹ˆå¤šæœåŠ¡ï¼Œå¦‚ä½•ç®¡ç†å®ƒä»¬ï¼Ÿ  æœåŠ¡æ²»ç†ã€æ³¨å†Œä¸­å¿ƒã€æœåŠ¡æ³¨å†Œ å‘ç° åˆ é™¤ã€‘ nacos
   
   - è¿™ä¹ˆå¤šæœåŠ¡ï¼Œå®ƒä»¬ä¹‹é—´å¦‚ä½•é€šè®¯ï¼Ÿrestful rpc,feign httpclient springboot restTemplate
   
   - è¿™ä¹ˆå¤šæœåŠ¡ï¼Œä¸€ä½†å‡ºç°é—®é¢˜äº†ï¼Œåº”è¯¥å¦‚ä½•è‡ªå¤„ç†ï¼Ÿ ï¼ˆå®¹é”™ï¼‰sentinel 
   
   - è¿™ä¹ˆå¤šæœåŠ¡ï¼Œä¸€ä½†å‡ºç°é—®é¢˜äº†ï¼Œåº”è¯¥å¦‚ä½•æ’é”™ï¼Ÿ ï¼ˆé“¾è·¯è¿½è¸ªï¼‰ skywalking
   
     å¯¹äºä»¥ä¸Šé—®é¢˜ï¼Œæ˜¯ä»»ä½•ä¸€ä¸ªå¾®æœåŠ¡è®¾è®¡è€…éƒ½ä¸èƒ½ç»•è¿‡å»çš„å¿½ç•¥çš„é—®é¢˜,å› æ­¤ï¼Œå¤§éƒ¨åˆ†çš„å¾®æœåŠ¡äº§å“éƒ½é’ˆå¯¹æ¯ä¸€ä¸ªé—®é¢˜æä¾›å“åº”çš„ç»„ä»¶æ¥è§£å†³å®ƒä»¬ã€‚
   
     ![image-20240429215149093](D:\projects\markdown\assets\image-20240429215149093.png)
   
   ![image-20240429215818026](D:\projects\markdown\assets\image-20240429215818026.png)

1.2 å¸¸è§çš„å¾®æœåŠ¡æ¶æ„ 

<img src="D:\projects\markdown\assets\image-20240429220016383.png" alt="image-20240429220016383" style="zoom:80%;" />

â€‹				[Spring Cloud Alibaba æ˜¯ä»€ä¹ˆ | https://sca.aliyun.com](https://sca.aliyun.com/docs/2023/overview/what-is-sca/)



# äºŒã€å¾®æœåŠ¡æ¶æ„



## 1ã€æœåŠ¡å™¨æ­å»º

 ### 1.1 è™šæ‹Ÿæœºè§„åˆ’

| è™šæœºå | IP             | ä½œç”¨                   | OS              |
| ------ | -------------- | ---------------------- | --------------- |
| node   | 192.168.130.10 | database mysql8; Nacos | CentOS 9 Stream |
| node1  | 192.168.130.11 | k8s node1              | CentOS 9 Stream |
| node2  | 192.168.130.12 | k8s node2              | CentOS 9 Stream |
| node3  | 192.168.130.13 | k8s node3              | CentOS 9 Stream |
|        |                |                        |                 |
|        |                |                        |                 |
|        |                |                        |                 |

### 1.2ã€è™šæœºå®‰è£…ä¸é…ç½®

NAT 

é™æ€IP

```bash
[root@localhost system-connections]# cat /proc/version
Linux version 5.14.0-437.el9.x86_64 (mockbuild@x86-05.stream.rdu2.redhat.com) (gcc (GCC) 11.4.1 20231218 (Red Hat 11.4.1-3), GNU ld version 2.35.2-43.el9) #1 SMP PREEMPT_DYNAMIC Tue Apr 9 12:57:02 UTC 2024
```

#### 1.2.1ã€é…ç½®ç½‘ç»œï¼ˆé™æ€IPï¼‰

  ##### 2.1.1 VMware Virtual Ethernet Adapter for VMnet8

IPï¼š 192.168.130.1

mask: 255.255.255.0

default gateway:  ç©ºç™½

DNS: ç©ºç™½

##### 2.1.2 VMWare è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨ 

ç½‘ç»œï¼š vmnet8

å­ç½‘IP: 192.168.130.0

å­ç½‘æ©ç ï¼š255.255.255.0

ç½‘å…³IP: 192.168.130.2

DHCP èµ·å§‹IP: 192.168.130.10 ~192.168.130.20

##### 2.1.3 è™šæ‹ŸIPè®¾ç½®

```bash
## ç¬¬1æ­¥ï¼š ä¿®æ”¹ç½‘ç»œé…ç½®æ–‡ä»¶
[root@localhost ~]# vim /etc/NetworkManager/system-connections/ens160.nmconnection

[connection]
id=ens160
uuid=9cb0efed-7f4b-39f0-a9ed-e2d6d9e7272a
type=ethernet
autoconnect-priority=-999
interface-name=ens160
timestamp=1714086861

[ethernet]

[ipv4]
#ç½‘å…³ä¸ºVMware8 ä¸­è®¾ç½®çš„ç½‘å…³ ä¸€èˆ¬æ˜¯n.n.n.2
address1=192.168.130.12/24,192.168.130.2
#DNSè®¾ç½®ï¼š 114.114.114.114ï¼›8.8.8.8; 192.168.2.1(å¯ä»¥æ˜¯ä¸»æœºç½‘å…³IP)
dns=8.8.8.8;
#é™æ€IP
method=manual

[ipv6]
addr-gen-mode=eui64
method=auto

[proxy]

## ç¬¬2æ­¥ï¼š é‡æ–°åŠ è½½ç½‘ç»œé…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”é‡å¯ç½‘ç»œ
[root@localhost ~]# nmcli c reload
[root@localhost ~]# nmcli c up ens160
Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/3)

[root@localhost ~]# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens160: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 00:0c:29:ca:3c:0e brd ff:ff:ff:ff:ff:ff
    altname enp3s0
    inet 192.168.130.12/24 brd 192.168.130.255 scope global noprefixroute ens160
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:feca:3c0e/64 scope link noprefixroute
       valid_lft forever preferred_lft forever


```

##### 2.1.4 æŸ¥çœ‹å½“å‰è¿æ¥

```bash
[root@localhost ~]# nmcli connection show
NAME    UUID                                  TYPE      DEVICE
ens160  9cb0efed-7f4b-39f0-a9ed-e2d6d9e7272a  ethernet  ens160
lo      18260ad9-e881-40a3-926b-8d4ddac0507c  loopback  lo

```

##### 2.1.5 æŸ¥çœ‹å½“å‰è¿æ¥å…¨éƒ¨ä¿¡æ¯

```bash
[root@localhost ~]# nmcli device show
GENERAL.DEVICE:                         ens160
GENERAL.TYPE:                           ethernet
GENERAL.HWADDR:                         00:0C:29:CA:3C:0E
GENERAL.MTU:                            1500
GENERAL.STATE:                          100 (connected)
GENERAL.CONNECTION:                     ens160
GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveConnection/2
WIRED-PROPERTIES.CARRIER:               on
IP4.ADDRESS[1]:                         192.168.130.10/24
IP4.GATEWAY:                            192.168.130.2
IP4.ROUTE[1]:                           dst = 192.168.130.0/24, nh = 0.0.0.0, mt = 100
IP4.ROUTE[2]:                           dst = 0.0.0.0/0, nh = 192.168.130.2, mt = 100
IP4.DNS[1]:                             8.8.8.8
IP6.ADDRESS[1]:                         fe80::20c:29ff:feca:3c0e/64
IP6.GATEWAY:                            --
IP6.ROUTE[1]:                           dst = fe80::/64, nh = ::, mt = 1024

GENERAL.DEVICE:                         lo
GENERAL.TYPE:                           loopback
GENERAL.HWADDR:                         00:00:00:00:00:00
GENERAL.MTU:                            65536
GENERAL.STATE:                          100 (connected (externally))
GENERAL.CONNECTION:                     lo
GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveConnection/1
IP4.ADDRESS[1]:                         127.0.0.1/8
IP4.GATEWAY:                            --
IP6.ADDRESS[1]:                         ::1/128
IP6.GATEWAY:                            --
IP6.ROUTE[1]:                           dst = ::1/128, nh = ::, mt = 256

```

##### 2.1.6 å›¾å½¢è®¾ç½®å‘½ä»¤

```bash
[root@localhost ~]# nmtui

```

### 1.3ã€æŸ¥çœ‹ä¸»æœºä¿¡æ¯

```bash
##ä¿®æ”¹ä¸»æœºå
[root@localhost ~] hostnamectl set-hostname node2
##é‡æ–°ç™»å½•
[root@node2 ~]# hostnamectl
 Static hostname: node2
       Icon name: computer-vm
         Chassis: vm ğŸ–´
      Machine ID: 0ff8124c766b49fc989216a9b074466f
         Boot ID: eb90b55d1a324891a3e41206f1d432b0
  Virtualization: vmware
Operating System: CentOS Stream 9
     CPE OS Name: cpe:/o:centos:centos:9
          Kernel: Linux 5.14.0-437.el9.x86_64
    Architecture: x86-64
 Hardware Vendor: VMware, Inc.
  Hardware Model: VMware20,1
Firmware Version: VMW201.00V.21805430.B64.2305221830

```

### 1.4. JAVA ç¯å¢ƒå®‰è£…

#### 4.1 JAVAä¸‹è½½ 

[Java Archive | Oracle India](https://www.oracle.com/in/java/technologies/downloads/archive/)

Oracleå¸å·ï¼š574814729@qq.com

Oracleå¯†ç ï¼šOracle123.

#### 4.2 JAVAå®‰è£…ç›®å½• 

```bash
[root@node ~]# mkdir /usr/local/java
[root@node ~]# tar -zxvf /usr/local/java/jdk-8u401* -C /usr/local/java/
[root@node ~]# ls /usr/local/java
jdk1.8.0_401  jdk-8u401-linux-x64.tar.gz


```

#### 4.3 é…ç½®Javaç¯å¢ƒå˜é‡

```bash
 [root@node ~]# vim /etc/profile
 ##åœ¨æ–‡ä»¶æœ€åæ·»åŠ 
 export JAVA_HOME=/usr/local/java/jdk1.8.0_401
 export PATH=$PATH:$JAVA_HOME/bin
 ## ç¯å¢ƒç”Ÿæ•ˆ
 [root@node ~]# source /etc/profile
 ## æ£€æŸ¥å®‰è£…
 [root@node ~]# whereis java
 java: /usr/local/java /usr/local/java/jdk1.8.0_401/bin/java


```



## 2ã€Docker Engineå®‰è£…ä¸è®¾ç½®

#### 2.1 å®‰è£…æ­¥éª¤

å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[Install Docker Engine on CentOS | Docker Docs](https://docs.docker.com/engine/install/centos/)

```bash
## 1. uninstall old version
[root@node ~]# yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
## 2. Set up the repository                  
[root@node ~]#  yum install -y yum-utils
[root@node ~]# yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
## 3. Install Docker Engine
[root@node ~]#  yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

## 4. Start Docker
[root@node ~]#

## 5. Verify that the Docker Engine installation is successful by running the hello-world image.
[root@node ~]# docker run hello-world

```

## 3ã€MySQL8å®‰è£…

åœ¨â€œnodeâ€è™šæ‹Ÿæœºä¸­å®‰è£…

### 3.1ã€å®‰è£…è¿‡ç¨‹

```bash
## 1.1. åˆ›å»º /usr/local/mysql8
[root@node ~]#  mkdir /usr/local/mysql8
## 1.2. è§£å‹
[root@node ~]#  tar -xf mysql-8.0.36-1.el9.x86_64.rpm-bundle.tar -C /usr/local/mysql8
## 1.3. å®‰è£…openssl-devel Perlæ’ä»¶
[root@node ~]# yum install openssl-devel 
[root@node ~]# yum  install perl

## 1.4. è¿›å…¥å®‰è£…ç›®å½•ï¼Œå®‰è£…Mysql 
[root@node ~]# cd /usr/local/mysql8
[root@node ~]# rpm -ivh mysql-community-common-8.0.36-1.el9.x86_64.rpm
[root@node ~]# rpm -ivh mysql-community-client-plugins-8.0.36-1.el9.x86_64.rpm
[root@node ~]# rpm -ivh mysql-community-libs-8.0.36-1.el9.x86_64.rpm
[root@node ~]# rpm -ivh mysql-community-client-8.0.36-1.el9.x86_64.rpm
[root@node ~]# rpm -ivh mysql-community-icu-data-files-8.0.36-1.el9.x86_64.rpm
[root@node ~]# rpm -ivh mysql-community-server-8.0.36-1.el9.x86_64.rpm
```

### 3.2. å¯åŠ¨

### 3.2.1 å¯åŠ¨Mysql

``` bash
## å¯åŠ¨ MySQL æœåŠ¡
[root@node ~]# systemctl start mysqld
## æŸ¥çœ‹å¯åŠ¨çŠ¶æ€
[root@node ~]# systemctl status mysqld
```

### 3.2.2 ä¿®æ”¹å¯†ç 

rpm å®‰è£… MySQL ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºå¯†ç ï¼Œåœ¨ /var/log/mysqld.log è¿™ä¸ªæ–‡ä»¶ä¸­æŸ¥æ‰¾è¯¥å¯†ç .

[Server] A temporary password is generated for root@localhost:  <u>**s3aXide9jz;Q**</u>



```bash
## 1.æŸ¥çœ‹åˆå§‹å¯†ç 
[root@node ~]#  cat /var/log/mysqld.log
...
2024-04-28T09:53:54.767040Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.
2024-04-28T09:53:55.117256Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.
2024-04-28T09:53:55.953144Z 6 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: s3aXide9jz;Q
2024-04-28T09:53:58.279436Z 0 [System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.36) starting as process 12562
2024-04-28T09:53:58.296817Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.
...
## 2. è¿æ¥ MySQL ä¿®æ”¹å¯†ç 
[root@node ~]# mysql -u root -p
# 3. ç¬¬ä¸€æ¬¡éœ€è¦è®¾ç½®å¤æ‚å¯†ç  å¤§å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šç¬¦å·
alter user 'root'@'localhost' identified by 'Root1234+';
# 4. å¸è½½mysqlçš„å¯†ç è§„åˆ™æ•ˆéªŒ
UNINSTALL COMPONENT 'file://component_validate_password';
# åœ¨å°†å¯†ç è®¾ç½®ä¸ªç®€å•çš„
# tipsï¼š'00000' å¯ä»¥è‡ªå®šä¹‰ä¸ºä½ æƒ³è¦çš„å¯†ç 
alter user 'root'@'localhost' identified by 'root';
# åˆ‡æ¢åˆ°mysqlæ•°æ®åº“
use mysql;
#è®©rootç”¨æˆ·å¯ä»¥åœ¨ä»»æ„ä¸»æœºä¸Šç™»å½•
update user set host = '%' where user = 'root';
# ä½¿é…ç½®ç”Ÿæ•ˆ
flush privileges
```

### 3.2.4 å¼€é˜²ç«å¢™

```bash
## æ£€æŸ¥é˜²ç«å¢™ æŸ¥çœ‹3306ç«¯å£

[root@node ~]# firewall-cmd --list-all

## å¼€æ”¾3306ç«¯å£
[root@node ~]# firewall-cmd --add-port=3306/tcp --permanent
success
## é‡å¯é˜²ç«å¢™
[root@node ~]# firewall-cmd --reload
success
## æŸ¥çœ‹é˜²ç«å¢™ç«¯å£ 3306
[root@node ~]# firewall-cmd --list-ports
3306/tcp
## æŸ¥çœ‹é˜²ç«å¢™æœåŠ¡ mysql
[root@node ~]# firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: ens160
  sources:
  services: cockpit dhcpv6-client mysql ssh
  ports: 3306/tcp
  protocols:
  forward: yes
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:


```

### 3.2.5 Navicat è¿æ¥

è¿æ¥æˆåŠŸ

## 4ã€Mavenå®‰è£…

### 4.1 ä¸‹è½½å®‰è£…

å®˜ç½‘ï¼šhttps://maven.apache.org/download.cgi

...

[åœ¨centos stream 9ä¸Šæ­å»ºk8sæœ€æ–°ç‰ˆæœ¬ï¼ˆå½“å‰ï¼šv1.26.1ï¼‰é›†ç¾¤ç¯å¢ƒ - zengql - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/zengqinglei/p/17131046.html)

# ä¸‰ã€SpringCloudé¡¹ç›®æ­å»º

#### 1ã€IDEå¼€å‘ç¯å¢ƒ	

â€‹	JDK:  64 bit JDK17.0.11

â€‹	Maven: 3.9

#### 2ã€é¡¹ç›®æ¡†æ¶

###### 2.1. åˆ›å»ºåŸºäºSpringbootçš„çˆ¶Mavené¡¹ç›®

â€‹	Spring Initializer:  springboot 3.2.5 

â€‹	 JDKï¼š		17.0.11 

######  2.1.1 çˆ¶å·¥ç¨‹é¡¹ç›®çš„Springcloud+springcloudalibabaç‰ˆæœ¬

~~~
     spring-boot version: 			3.2.5 
     spring-cloud-alibaba version: 	2023.0.1.0
     spring-cloud version: 			2023.0.1
~~~



######  2.1.2 çˆ¶å·¥ç¨‹é¡¹ç›®çš„POM

~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.cocacola.springcloud</groupId>
    <artifactId>springcloudalibaba</artifactId>
    <packaging>pom</packaging>
    <name>springcloudalibaba</name>
    <description>Parent pom providing dependency for applications</description>
    <modules>
        <module>orderservice</module>
        <module>stockservice</module>
    </modules>
    <version>0.0.1</version>
    <properties>
        <java.version>17</java.version>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <maven.compiler.compilerVersion>17</maven.compiler.compilerVersion>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
        <spring-boot.version>3.2.5</spring-boot.version>
        <spring-cloud-alibaba.version>2023.0.1.0</spring-cloud-alibaba.version>
        <spring-cloud.version>2023.0.1</spring-cloud.version>

    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>${spring-boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>2023.0.1.0</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>



    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>${spring-boot.version}</version>
            </plugin>
        </plugins>
    </build>

</project>
~~~



##### 2.2 åˆ›å»ºä¸¤ä¸ªå­æ¨¡å—é¡¹ç›®ï¼ˆè®¢å•æœåŠ¡å’Œåº“å­˜æœåŠ¡)

###### 2.2.1 åº“å­˜æœåŠ¡é¡¹ç›®

```java
@RestController
@RequestMapping("/stock")
public class StockServiceController {
    //å‡åº“å­˜æœåŠ¡
    @RequestMapping("/reduce")
    public String reduce(){
        return "reduced";
    }
    
}
```

###### 2.2.2 è®¢å•æœåŠ¡é¡¹ç›®

æ·»åŠ è®¢å•API

```JAVA
@RestController
@RequestMapping("/order")
public class OrderServiceController {
    @Autowired
    RestTemplate restTemplate;
    @RequestMapping("/add")
    public String add(){
       //è°ƒç”¨åº“å­˜æœåŠ¡: åˆ†å¸ƒå¼åº”ç”¨é€šè¿‡resttemplateæ–¹æ³•è°ƒç”¨
        String url="http://localhost:8011/stock/reduce";
        String msg = restTemplate.getForObject(url,String.class);
        return "order has been created!"+ " and "+ msg;
    }
}
```



2.3. å¼•å…¥Spring cloud alibaba :

[ç‰ˆæœ¬è¯´æ˜ Â· alibaba/spring-cloud-alibaba Wiki Â· GitHub](https://github.com/alibaba/spring-cloud-alibaba/wiki/ç‰ˆæœ¬è¯´æ˜)

![image-20240504161019868](D:\projects\markdown\assets\image-20240504161019868.png)

 2.4. å‚è€ƒæ–‡æ¡£ï¼š

[Spring Cloud Alibaba Reference Documentation (spring-cloud-alibaba-group.github.io)](https://spring-cloud-alibaba-group.github.io/github-pages/2021/en-us/index.html#_dependency_management)

# å››ã€æœåŠ¡æ³¨å†Œä¸å‘ç°

#### 1. Nacosæ˜¯ä»€ä¹ˆ

æ˜¯ Dynamic Naming and Configuration Serviceçš„é¦–å­—æ¯ç®€ç§°ï¼Œä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚

Nacos çš„å…³é”®ç‰¹æ€§åŒ…æ‹¬:

- **æœåŠ¡å‘ç°å’ŒæœåŠ¡å¥åº·ç›‘æµ‹**

- **åŠ¨æ€é…ç½®æœåŠ¡**

- **åŠ¨æ€ DNS æœåŠ¡**

- **æœåŠ¡åŠå…¶å…ƒæ•°æ®ç®¡ç†**
#### 2. Nacosæ³¨å†Œä¸­å¿ƒ

![image-20240505102518295](D:\projects\markdown\assets\image-20240505102518295.png)

##### 2.1 ä¸‹è½½å®‰è£…Nacos

       https://nacos.io/docs/latest/what-is-nacos/

```xml
	nacos ç‰ˆæœ¬:    Nacos 2.3.2 
```

  #### 2.2 ä¸‹è½½ Nacos å¹¶å¯åŠ¨

å¯åŠ¨æ¨¡å¼ï¼š startup.cmd -m standalone

ç«¯å£: 8848

#### 2.3 pom å¢åŠ ä¾èµ–é…ç½®

è®¢å•æœåŠ¡ï¼Œåº“å­˜æœåŠ¡ pomï¼Œå¢åŠ nacosæœåŠ¡æ³¨å†Œ

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

#### 2.4 application.yml é…ç½®

```yml
server:
  port: 8011
spring:
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
      discovery:
        username: nacos
        password: nacos
        namespace: public #é»˜è®¤å‘½åç©ºé—´
  application:
    name: stock-service  #nacosä¼šå°†spring.application.nameåº”ç”¨åç§°å½“æœåŠ¡æ³¨å†Œåç§°
```

**nacos service name:** nacosä¼šå°†spring.application.nameåº”ç”¨åç§°å½“æœåŠ¡æ³¨å†Œåç§°ï¼›  ä¹Ÿå¯ä»¥é€šè¿‡nacosã€‚serviceé…ç½®é¡¹é…ç½®



```yml
server:
  port: 8020
spring:
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
      discovery:
        username: nacos
        password: nacos
        namespace: public #é»˜è®¤å‘½åç©ºé—´
        #service: é»˜è®¤å€¼æ˜¯ ${spring.application.name} ,ä¹Ÿå¯ä»¥é€šè¿‡è¯¥é…ç½®é¡¹é…ç½®
  application:
    name: order-service  #é»˜è®¤æƒ…å†µä¸‹ï¼Œnacosä¼šå°†spring.application.nameåº”ç”¨åç§°å½“æœåŠ¡æ³¨å†Œåç§°
    
```

#### 2.5 å¯åŠ¨å¹¶éªŒè¯

ç³»ç»Ÿæ—¥å¿—ï¼š

![image-20240505102403922](D:\projects\markdown\assets\image-20240505102403922.png)

Nacos:

![image-20240504230741313](D:\projects\markdown\assets\image-20240504230741313.png)

#### 2.6 æœåŠ¡æ³¨å†Œ-Nacoså®¢æˆ·ç«¯

###### 2.6.1 è®¢å•æœåŠ¡é€šè¿‡è°ƒç”¨æœåŠ¡å stock-serviceæ–¹å¼ï¼Œè°ƒç”¨åº“å­˜æœåŠ¡ã€‚

```java
@RequestMapping("/add")
public String add(){
    String url="";
    //url = "http://localhost:8011/stock/reduce";
    //åº“å­˜æœåŠ¡å
    url = "http://stock-service/stock/reduce";
    String msg = restTemplate.getForObject(url,String.class);
    return "order has been created!"+ " and "+ msg;
}
```

###### 2.6.2  å¼•å…¥è´Ÿè½½å‡è¡¡å™¨çš„ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-loadbalancer</artifactId>
</dependency>
```

###### 2.6.3 RestTemplaéœ€è¦é€šè¿‡è´Ÿè½½å‡è¡¡è¡¡å™¨è§£æï¼Œæ‰å¯ä»¥è°ƒç”¨NacosæœåŠ¡ã€‚ åŠ æ˜¯æ³¨è§£:

```java
@SpringBootApplication
public class OrderServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class,args);
        System.out.println("Order Service is Started!");
    }

    @Bean
    @LoadBalanced
    public RestTemplate restTemplate(RestTemplateBuilder builder){
        return builder.build();
    }
}
```

###### 2.6.4 å¯åŠ¨å¤šä¸ªstockæœåŠ¡

ä¸ºäº†åŒºåˆ†è°ƒç”¨å“ªä¸ªæœåŠ¡ï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ä¸­å¢åŠ ç«¯å£å·

```java
public class StockServiceController {
    @Value("${server.port}")
    int port;
    //å‡åº“å­˜æœåŠ¡
    @RequestMapping("/reduce")
    public String reduce(){
        return "reduced:" + port;
    }
}
```

æµ‹è¯•ï¼š

order has been created! and reduced:8021

order has been created! and reduced:8022

###### 2.6.5 è´Ÿè½½å‡è¡¡ Load balancer

- - 

###### 2.6.5 æœåŠ¡å‘ç°æ€»ç»“

![image-20240505131348846](D:\projects\markdown\assets\image-20240505131348846.png)

##### 2.6.6 Nacosç®¡ç†é¡µé¢

![image-20240505144328181](D:\projects\markdown\assets\image-20240505144328181.png)

   - å‘½åç©ºé—´

     

   - è¯¦æƒ…

     - åˆ†ç»„ï¼š æ¯”å‘½åç©ºé—´å°ä¸€çº§çš„åˆ†ç±»

     - ![1714891553902](D:\projects\markdown\assets\1714891553902.png)

     - **ä¿æŠ¤é˜ˆå€¼**ï¼šé›ªå´©ä¿æŠ¤ 0~1ä¹‹é—´ï¼Œ å¯ä»¥æ˜¯0.5. ä¸€èˆ¬ä¿æŒé»˜è®¤0ï¼Œæµé‡æ§åˆ¶ç”± sentinelæ²»ç†

       ä¸´æ—¶å®ä¾‹ï¼š 

       ```yml
       spring:
         cloud:
           nacos:
           	ephemeral: false
       ```

      - æƒé‡ã€ä¸‹çº¿

        ![1714892127532](D:\projects\markdown\assets\1714892127532.png)

     - è®¢é˜…è€…åˆ—è¡¨

       ![1714892352962](D:\projects\markdown\assets\1714892352962.png)

     - æ›´è¯¦ç»†- æ§åˆ¶å°æ‰‹å†Œ

        [æ§åˆ¶å°æ‰‹å†Œ (nacos.io)](https://nacos.io/zh-cn/docs/v2/guide/admin/console-guide.html)

#### 2.7 Nacosé›†ç¾¤æ¨¡å¼

##### 2.7.1 å®˜æ–¹æ–‡æ¡£

[é›†ç¾¤éƒ¨ç½²è¯´æ˜ (nacos.io)](https://nacos.io/zh-cn/docs/v2/guide/admin/cluster-mode-quick-start.html)

##### 2.7.1 é›†ç¾¤æ¨¡å¼

![deployDnsVipMode.jpg](https://nacos.io/img/deployDnsVipMode.jpg)

#### 2.7.2 å®‰è£…é¢„å‡†å¤‡

- ç¯å¢ƒä¸­å®‰è£…ä½¿ç”¨:

1. 64 bit OS Linux/Unix/Macï¼Œæ¨èä½¿ç”¨Linuxç³»ç»Ÿã€‚
2. 64 bit JDK 1.8+ï¼›[ä¸‹è½½](http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html). [é…ç½®](https://docs.oracle.com/cd/E19182-01/820-7851/inst_cli_jdk_javahome_t/)ã€‚
3. Maven 3.2.x+ï¼›[ä¸‹è½½](https://maven.apache.org/download.cgi). [é…ç½®](https://maven.apache.org/settings.html)ã€‚
4. 3ä¸ªæˆ–3ä¸ªä»¥ä¸ŠNacosèŠ‚ç‚¹æ‰èƒ½æ„æˆé›†ç¾¤ã€‚

- LInuxä¸­å®‰è£…æ­¥éª¤ï¼š

#### 2.7.3 Nacos å®‰è£…Linux 	

```bash
[root@node ~]# mkdir /usr/local/nacos
[root@node ~]# cd /usr/local/nacos

## 1. ä¸‹è½½

[root@node nacos]# wget https://github.com/alibaba/nacos/releases/download/2.3.2/nacos-server-2.3.2.tar.gz

[root@node nacos]# ls
nacos-server-2.3.2.tar.gz

## 2. è§£å‹

[root@node nacos]# tar -zxvf nacos-server-2.3.2.tar.gz
nacos/LICENSE
nacos/NOTICE
nacos/target/nacos-server.jar
nacos/conf/
nacos/conf/derby-schema.sql
nacos/conf/1.4.0-ipv6_support-update.sql
nacos/conf/announcement_zh-CN.conf
nacos/conf/application.properties.example
nacos/conf/nacos-logback.xml
nacos/conf/console-guide.conf
nacos/conf/mysql-schema.sql
nacos/conf/cluster.conf.example
nacos/conf/announcement_en-US.conf
nacos/conf/application.properties
nacos/bin/startup.sh
nacos/bin/startup.cmd
nacos/bin/shutdown.sh
nacos/bin/shutdown.cmd
## 3. ä¿®æ”¹é…ç½®


## 4. å¯åŠ¨æœåŠ¡å™¨ 
## å¯åŠ¨å‘½ä»¤(standaloneä»£è¡¨ç€å•æœºæ¨¡å¼è¿è¡Œï¼Œéé›†ç¾¤æ¨¡å¼):
[root@node nacos]# sh startup.sh -m standalone
## 5. å¼€é€šé˜²ç«å¢™
[root@node nacos]# firewall-cmd --add-port=8848/tcp --permanent
success
[root@node nacos]# firewall-cmd --add-port=9848/tcp --permanent
success
[root@node nacos]# firewall-cmd --reload
success

```

- éªŒè¯

  ![1714897653938](D:\projects\markdown\assets\1714897653938.png)

# äº”ã€è´Ÿè½½å‡è¡¡Loadbalancer

spring-cloud-loadbalancer

### 1. ä»€ä¹ˆæ˜¯ LoadBalancer
LoadBalancerï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼‰æ˜¯ä¸€ç§ç”¨æ¥**åˆ†å‘ç½‘ç»œæˆ–åº”ç”¨ç¨‹åºæµé‡åˆ°å¤šä¸ªæœåŠ¡å™¨**çš„æŠ€æœ¯ã€‚å®ƒå¯ä»¥é˜²æ­¢ä»»ä½•å•ä¸€æœåŠ¡çš„è¿‡è½½ï¼Œé€šè¿‡åˆ†æ•£è´Ÿè½½æ¥ä¿æŒæ•´ä¸ªç³»ç»Ÿçš„å¹³ç¨³è¿è¡Œï¼Œä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§å’Œå¯é æ€§ã€‚

### 2. è´Ÿè½½å‡è¡¡ç­–ç•¥åˆ†ç±»

è´Ÿè½½å‡è¡¡ç­–ç•¥å¤§ä½“ä¸Šåˆ†ä¸ºä¸¤ç±»ï¼šæœåŠ¡ç«¯çš„è´Ÿè½½å‡è¡¡å’Œå®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡

**â‘  æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡** ï¼ˆå¦‚ Nginxã€F5ï¼‰

è¯·æ±‚å…ˆåˆ°è¾¾ä¸€ä¸ªä¸­ä»‹ï¼ˆå¦‚è´Ÿè½½å‡è¡¡å™¨è®¾å¤‡æˆ–è€…æœåŠ¡ï¼Œä¾‹å¦‚Nginxï¼‰ï¼Œç”±è¿™ä¸ªä¸­ä»‹æ ¹æ®é…ç½®çš„ç­–ç•¥å°†è¯·æ±‚åˆ†å‘åˆ°åç«¯çš„å¤šä¸ªæœåŠ¡å™¨ä¸­ã€‚<u>å®ƒå¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„ï¼Œå³å®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“æœ‰å¤šå°‘æœåŠ¡å™¨ä»¥åŠå®ƒä»¬çš„å­˜åœ¨ã€‚</u>

![img](D:\projects\markdown\assets\d1f6ee3c7b334127982536c0d8810432.png)

**â‘¡ å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡** ï¼ˆå¦‚ Ribbonã€Spring Cloud LoadBalancerï¼‰

è¯·æ±‚çš„åˆ†é…é€»è¾‘ç”±å®¢æˆ·ç«¯æŒæœ‰ï¼Œå®¢æˆ·ç«¯ç›´æ¥å†³å®šå°†è¯·æ±‚å‘é€åˆ°å“ªä¸€ä¸ªæœåŠ¡å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ä¸­ï¼Œå®¢æˆ·ç«¯é€šå¸¸å…·å¤‡ä¸€ä»½æœåŠ¡åˆ—è¡¨ï¼Œå®ƒçŸ¥é“æ¯ä¸ªæœåŠ¡çš„å¥åº·çŠ¶å†µï¼ŒåŸºäºè¿™äº›ä¿¡æ¯å’Œè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå®¢æˆ·ç«¯ä¼šé€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆçš„æœåŠ¡å»å‘é€è¯·æ±‚ã€‚

![img](D:\projects\markdown\assets\414ed4106ebb4e66b68be5799ecf5e73.png)

### 3.å¸¸è§çš„è´Ÿè½½å‡è¡¡ç­–ç•¥

å¸¸è§çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æœ‰ä»¥ä¸‹å‡ ç§ï¼š

1. **è½®è¯¢ï¼ˆRound Robinï¼‰**ï¼šè½®è¯¢ç­–ç•¥å°±æ˜¯æŒ‰ç…§é¡ºåºæŠŠæ¯ä¸ªè¯·æ±‚åˆ†å‘ç»™æœåŠ¡ç«¯ï¼Œä¾æ¬¡å¾ªç¯ã€‚é€‚ç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘ï¼Œä¸”æ¯ä¸ªæœåŠ¡å™¨å¤„ç†æ—¶é—´ç›¸è¿‘çš„æƒ…å†µ
2. **éšæœºé€‰æ‹©ï¼ˆRandomï¼‰**ï¼šæŠŠè¯·æ±‚éšæœºå‘ç»™åç«¯æœåŠ¡å™¨ï¼Œé€‚ç”¨äºåç«¯æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘ï¼Œä¸”æ¯ä¸ªæœåŠ¡å™¨å¤„ç†æ—¶é—´ç›¸è¿‘çš„æƒ…å†µï¼Œä½†æ— æ³•ä¿è¯è¯·æ±‚å‡ä¸åˆ†å‘
3. **æœ€å°‘é“¾æ¥ï¼ˆLeast Connectionsï¼‰**ï¼šæœ€å°‘è¿æ¥ç­–ç•¥å°†è¯·æ±‚åˆ†å‘ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„åç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥ç¡®ä¿åç«¯æœåŠ¡å™¨è¿æ¥å‡è¡¡ï¼Œéœ€è¦ç»´æŠ¤è¿æ¥è®¡æ•°å™¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`â€œæœ€å°‘è¿æ¥æ•°â€åªæ˜¯ä¸€ä¸ªä¼°è®¡å€¼`ï¼Œåœ¨åƒå˜ä¸‡åŒ–çš„ç½‘ç»œç¯å¢ƒä¸‹ï¼Œè¿æ¥æ•°ä¹Ÿåœ¨å˜åŒ–ã€‚
4. **IP å“ˆå¸Œï¼ˆIP Hashï¼‰**ï¼šæ ¹æ®å®¢æˆ·ç«¯IPåœ°å€è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œæ ¹æ®å“ˆå¸Œå€¼å°†è¯·æ±‚å‘é€åˆ°å¯¹åº”æœåŠ¡å™¨ä¸Šã€‚è¿™ç§ç­–ç•¥å¯ä»¥ç”¨äºç¡®ä¿æ¥è‡ªåŒä¸€å®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½ä¼šè¢«å‘é€åˆ°åç«¯æœåŠ¡å™¨ï¼Œé€‚ç”¨äºä¼šè¯ä¿æŒçš„æƒ…å†µã€‚
5. **åŠ æƒè½®è¯¢ï¼ˆWeight Round Robinï¼‰**ï¼šç»™æ¯ä¸ªåç«¯æœåŠ¡å™¨åˆ†é…ä¸€ä¸ªæƒé‡å€¼ï¼Œç„¶åæŒ‰ç…§æƒå€¼æ¯”ä¾‹æ¥åˆ†å‘è¯·æ±‚ï¼Œè¿™ç§ç­–ç•¥å¯ä»¥ç”¨æ¥å¤„ç†æœåŠ¡å™¨æ€§èƒ½ä¸å‡è¡¡çš„æƒ…å†µã€‚
6. **åŠ æƒéšæœºï¼ˆWeigh Randomï¼‰**ï¼šä¸åŠ æƒè½®è¯¢ç±»ä¼¼ï¼Œä½†æ˜¯æŒ‰ç…§æƒé‡å€¼æ¥éšæœºé€‰æ‹©åç«¯æœåŠ¡å™¨ã€‚è¿™ä¹Ÿå¯ä»¥ç”¨æ¥å¤„ç†åç«¯æœåŠ¡å™¨æ€§èƒ½ä¸å‡è¡¡çš„æƒ…å†µï¼Œä½†æ˜¯åˆ†å‘æ›´éšæœºã€‚
7. **æœ€çŸ­å“åº”æ—¶é—´ï¼ˆLeast Response Timeï¼‰**ï¼šæ ¹æ®åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æƒ…å†µï¼Œåˆ†å‘è¯·æ±‚åˆ°å“åº”æ—¶é—´æœ€çŸ­çš„æœåŠ¡å™¨ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿å®¢æˆ·ç«¯æˆ–è€…æœ€å¿«çš„å“åº”ï¼Œé€‚ç”¨äºä½å»¶è¿Ÿçš„åº”ç”¨ã€‚



### 4. Spring Cloud Balancer

Ribbon ä½œä¸ºæ—©æœŸçš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å·¥å…·ï¼Œåœ¨ Spring Cloud 2020.0.0 ç‰ˆæœ¬ä¹‹åå·²ç»è¢«ç§»é™¤äº†ï¼›å–è€Œä»£ä¹‹çš„æ˜¯ Spring Cloud LoadBalancer,ä¸ºSpringCloudå®˜æ–¹rè´Ÿè½½å‡è¡¡

#### 4.1 è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š

Spring Cloud LoadBalancerä¸­ä»…æä¾›äº†ä¸‰ç§è´Ÿè½½å‡è¡¡ç­–ç•¥

- è½®è¯¢
- åŠ æƒ
- è‡ªå®šä¹‰ï¼ˆNacosçš„è´Ÿè½½å‡è¡¡ç®—alibabaè‡ªå®šä¹‰ï¼‰

é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æ˜¯è½®è¯¢çš„ç­–ç•¥

å¯ä»¥é€šè¿‡Spring Cloud LoadBalancerçš„é…ç½®ç±»LoadBalancerClientConfigurationæŸ¥çœ‹åº•å±‚é…ç½®

#### 4.2 ç¼“å­˜æœºåˆ¶

Spring Cloud LoadBalanceråœ¨è·å–å®ä¾‹æ—¶æœ‰ä¸¤ç§é€‰æ‹©
1.**å³ä½¿è·å–**ï¼š

æ¯æ¬¡ä»æ³¨å†Œä¸­å¿ƒå¾—åˆ°æœ€æ–°å¥åº·çš„å®ä¾‹ï¼Œæ•ˆæœå¥½ï¼Œä½†æ˜¯å¾—ä¸€ç›´è¯¢é—®ï¼Œç³»ç»Ÿå¼€é”€æ¯”è¾ƒå¤§

2.**ç¼“å­˜æœåŠ¡åˆ—è¡¨**ï¼š

æ¯æ¬¡å¾—åˆ°æœåŠ¡åˆ—è¡¨ä¹‹åï¼Œç¼“å­˜ä¸€æ®µæ—¶é—´ï¼Œè¿™æ ·èƒ½ä¿è¯æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿèƒ½å…¼å®¹ä¸€å®šçš„åŠæ—¶æ€§

- Spring Cloud LoadBalancerä¸­é»˜è®¤å¼€å§‹ç¼“å­˜æœåŠ¡åˆ—è¡¨

- Spring Cloud LoadBalanceré»˜è®¤ç¼“å­˜é‡è¦ç‰¹æ€§æœ‰ä¸¤é¡¹

1. ç¼“å­˜çš„è¿‡æœŸæ—¶é—´ä¸º35S
2. ç¼“å­˜ä¿å­˜ä¸ªæ•°ä¸º256ä¸ª

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®æ”¹å˜è¿™äº›é…ç½®ï¼š

<img src="D:\projects\markdown\assets\image-20240505164040092.png" alt="image-20240505164040092" style="zoom:67%;" />

# å…­ã€Spring Cloud OpenFeign

### 1ã€ä»€ä¹ˆæ˜¯Feign

Feignæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„Web Serviceå®¢æˆ·ç«¯,ä»¥Javaæ¥å£æ³¨è§£çš„æ–¹å¼è°ƒç”¨Httpè¯·æ±‚ã€‚åŒæ—¶Feignæ•´åˆäº†Ribbonå’ŒHystrixï¼Œå®ç°è´Ÿè½½å‡è¡¡ä¸å®¹æ–­åŠŸèƒ½ã€‚

#### 1.1 Feignçš„ç›®æ ‡æ˜¯ç®€åŒ–HTTP Clientã€‚

â€‹	Feignæ˜¯åŸºäºRibbonå°è£…çš„HTTP Clientå·¥å…·åŒ…ã€‚

â€‹	åœ¨ä¸ä½¿ç”¨Feignä¹‹å‰ï¼Œåœ¨å¾®æœåŠ¡ä¸­ï¼Œä¸€ä¸ªæ¨¡å—å¦‚æœæƒ³è¦è°ƒç”¨å¦ä¸€ä¸ªæ¨¡å—ä¸­çš„æŸä¸ªåŠŸèƒ½ï¼Œéœ€è¦å‘å…¶å‘èµ·è¯·æ±‚httpè¯·æ±‚ï¼Œä¾‹å¦‚ï¼Œ ä½¿ç”¨RestTemplateå‘èµ·è¿œç¨‹è°ƒç”¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public String add(){
    String url="";
    //url = "http://localhost:8011/stock/reduce";
    //åº“å­˜æœåŠ¡å: stock-service
    url = "http://stock-service/stock/reduce";
    String msg = restTemplate.getForObject(url,String.class);
    return "order has been created!"+ " and "+ msg;
}
```

Feignå¯ä»¥å¸®åŠ©æˆ‘ä»¬å‘é€httpè¯·æ±‚ï¼Œæ¯”è¾ƒä¼˜é›…åœ°è°ƒç”¨å¦å¤–ä¸€ä¸ªæœåŠ¡ã€‚



#### 1.2 Feignå…·æœ‰å¦‚ä¸‹ç‰¹æ€§

- å¯æ’æ‹”çš„æ³¨è§£æ”¯æŒï¼ŒåŒ…æ‹¬Feignæ³¨è§£å’ŒJAX-RSæ³¨è§£;
- æ”¯æŒå¯æ’æ‹”çš„HTTPç¼–ç å™¨å’Œè§£ç å™¨;
- æ”¯æŒHystrixå’Œå®ƒçš„Fallback;
- æ”¯æŒRibbonçš„è´Ÿè½½å‡è¡¡;
- æ”¯æŒHTTPè¯·æ±‚å’Œå“åº”çš„å‹ç¼©
- feign**ä¸æ”¯**æŒGETè¯·æ±‚ç›´æ¥ä¼ é€’POJOå¯¹è±¡çš„.

#### 1.3 æ„å»ºå™¨

æ„å»ºå™¨æ˜¯è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯beanå¹¶è¿”å›ä¸€ä¸ªFeignæ„å»ºå™¨ã€‚ç”Ÿæˆæ–¹å¼æœ‰äºŒç§ï¼š

(1) åŸºäºé¢å‘æ¥å£çš„åŠ¨æ€ä»£ç†æ–¹å¼ç”Ÿæˆå®ç°ç±»ã€‚ä½¿ç”¨Feign.builder()æ“ä½œç±»å®ç°ã€‚ 

(2) ä½¿ç”¨æ³¨è§£@EnableFeignClientså¯ç”¨feignå®¢æˆ·ç«¯ã€‚

#### 1.4 è‡ªå®šä¹‰Feignçš„é…ç½®

Spring Bootè‡ªåŠ¨è£…é…äº†Feignçš„é…ç½®ï¼Œä½†æ˜¯æˆ‘ä»¬è‡ªå·±æ˜¯å¯ä»¥ä¿®æ”¹æˆ–è€…è‡ªå®šä¹‰Feignçš„é…ç½®çš„ï¼Œå¯ä»¥ä¿®æ”¹çš„é…ç½®å¦‚ä¸‹ï¼š

![img](https://img-blog.csdnimg.cn/fe5f5a9e11ef47208b1582da5f28c184.png)

ç®€å•æ¥è¯´ä¸€ä¸‹æ—¥å¿—ï¼Œæ—¥å¿—ä¸€å…±åˆ†ä¸ºå››ä¸ªçº§åˆ«

NONEï¼šæ²¡æœ‰ä»»ä½•æ—¥å¿—ï¼Œä¹Ÿæ˜¯é»˜è®¤é…ç½®ï¼›

BASICï¼šå¯ä»¥è®°å½•httpè¯·æ±‚ä»€ä¹ˆæ—¶å€™å‘é€ï¼Œä»€ä¹ˆæ—¶å€™ç»“æŸï¼Œè€—æ—¶å¤šä¹…ç­‰åŸºæœ¬ä¿¡æ¯ï¼›

HEADERSï¼šé™¤äº†BASICä¸­å«æœ‰çš„ä»¥å¤–ï¼Œè¿˜åŒ…å«è¯·æ±‚å¤´å’Œå“åº”å¤´ï¼› 

FULLï¼šæ˜¯æœ€å…¨é¢çš„ï¼Œé™¤äº†HEADERSä¸­åŒ…å«çš„ä»¥å¤–ï¼Œè¿˜åŒ…å«è¯·æ±‚ä½“ä¿¡æ¯å’Œå“åº”ä½“ä¿¡æ¯ã€‚

åœ¨application.ymlæ–‡ä»¶ä¸­çš„å…¨å±€é…ç½®å¦‚ä¸‹ï¼š

![img](https://img-blog.csdnimg.cn/b721cf29a62b4147a2f8f9988405675a.png)

![img](https://img-blog.csdnimg.cn/cc97063f112f499895affce40d57089b.png)

 å¦‚æœæ˜¯è°ƒè¯•é”™è¯¯çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨FULLï¼›ä½†å¦‚æœæ—¥å¸¸å¼€å‘ï¼Œå»ºè®®ä½¿ç”¨NONEæˆ–BASICã€‚å› ä¸ºè®°å½•æ—¥å¿—ä¹Ÿæ˜¯ä¼šæ¶ˆè€—ä¸€å®šçš„æ€§èƒ½çš„ã€‚

### 2ã€ å¦‚ä½•ä½¿ç”¨Feign

#### 2.1 å¼•å…¥ä¾èµ–

åœ¨æœåŠ¡æ¶ˆè´¹ç«¯å¼•å…¥ä¾èµ–ï¼Œå³ï¼Œå½“æ¨¡å—Aè¦è°ƒç”¨æ¨¡å—Bçš„æ–¹æ³•æ—¶ï¼Œè¦åœ¨è°ƒç”¨è€…Aä¸­åŠ å…¥Feignã€‚

~~~xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
~~~

#### 2.2 æ·»åŠ å¯åŠ¨æ³¨è§£

åœ¨æ¶ˆè´¹è€…é¡¹ç›®çš„å¯åŠ¨ç±»ï¼Œæ·»åŠ å¯åŠ¨Feignçš„æ³¨è§£@EnableFeignClientsã€‚ **ä¸åŠ æ³¨è§£æ˜¯ä¸ä¼šå¼€å¯FeignåŠŸèƒ½**ã€‚

```java
@SpringBootApplication
@EnableFeignClients
public class OrderServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class,args);
        System.out.println("Order Service is Started!");
    }

}
```

#### 2.3 ç¼–å†™Feignçš„å®¢æˆ·ç«¯

åœ¨order-serviceä¸­ï¼Œåˆ›å»ºè®¢å•æ—¶éœ€è¦è°ƒç”¨stockserviceå±‚å‡åº“å­˜çš„æ–¹æ³•ã€‚



~~~java
public String add(){//åˆ›å»ºè®¢å•ï¼Œè°ƒç”¨å‡åº“å­˜
    String url="";
    //åº“å­˜æœåŠ¡å: stock-service
    url = "http://stock-service/stock/reduce";
    String msg = restTemplate.getForObject(url,String.class);
    return "order has been created!"+ " and "+ msg;
}
~~~

åœ¨orderserviceæ¨¡å—ä¸­æ–°å»ºä¸€ä¸ªåŒ…clientï¼Œéœ€è¦å£°æ˜çš„å®¢æˆ·ç«¯å¦‚ä¸‹ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæ¥å£ï¼š

~~~java
@FeignClient("stock-service")
public interface StockService {
    @RequestMapping("/stock/reduce/{id}")
    String reduce(@PathVariable("id") Long id);
}
~~~

- clientä¸­çš„æ–¹æ³•å®šä¹‰:

  éœ€è¦å’ŒStockServiceä¸­çš„æ–¹æ³•ä½“ä¿æŒä¸€è‡´ï¼Œéƒ½è¦ä½¿ç”¨@RequestMappingï¼Œè·¯å¾„ä¹Ÿè¦ä¿æŒä¸€è‡´ã€‚

- @[FeignClient](https://so.csdn.net/so/search?q=FeignClient&spm=1001.2101.3001.7020)(value = "stock-service")  

  valueå€¼éœ€è¦æ˜¯åº“å­˜æœåŠ¡çš„æœåŠ¡åç§°ï¼š stock-serviceã€‚

#### 2.4 æ”¹å†™è°ƒç”¨æ–¹

~~~java

        /** ä¼ ç»Ÿä½¿ç”¨Springboot rest tamplateè°ƒç”¨æ–¹æ³•
		String url="";
        //åº“å­˜æœåŠ¡å: stock-service
        url = "http://stock-service/stock/reduce/100";
        String msg = restTemplate.getForObject(url,String.class);
        **/

        //ä½¿ç”¨Feignè¿œç¨‹è°ƒç”¨
        String msg = stockService.reduce(100L);
        return "order has been created!"+ " and "+ msg;
    }
~~~

